[
  {
    "$group": {
      "_id": null,
      "count": {
        "$sum": 1
      },
      "minBet": {
        "$min": "$cAt"
      },
      "maxBet": {
        "$max": "$cAt"
      },
      "minCollated": {
        "$min": "$collatedAt"
      },
      "maxCollated": {
        "$max": "$collatedAt"
      },
      "avgChangeStreamDelay": {
        "$avg": "$diff"
      },
      "minChangeStreamDelay": {
        "$min": "$diff"
      },
      "maxChangeStreamDelay": {
        "$max": "$diff"
      },
      "changeStreamDelayPercentiles": {
        "$percentile": {
          "input": "$diff",
          "p": [0.5, 0.95, 0.99],
          "method": "approximate"
        }
      }
    }
  },
  {
    "$set": {
      "betAcceptanceDuration": {
        "$dateDiff": {
          "startDate": "$minBet",
          "endDate": "$maxBet",
          "unit": "millisecond"
        }
      },
      "betCollationDuration": {
        "$dateDiff": {
          "startDate": "$minCollated",
          "endDate": "$maxCollated",
          "unit": "millisecond"
        }
      }
    }
  },
  {
    "$project": {
      "_id": {
        "$dateToString": {
          "format": "%Y-%m-%d %H:%M:%S",
          "date": new Date()
        }
      },
      "noOfBets": "$count",
      "betAcceptance": {
        "duration": "$betAcceptanceDuration",
        "avgProcessTime": {
          "$divide": [
            "$betAcceptanceDuration",
            "$count"
          ]
        },
        "tps": {
          "$divide": [
            "$count",
            {
              "$divide": [
                "$betAcceptanceDuration",
                1000
              ]
            }
          ]
        }
      },
      "betCollation": {
        "duration": "$betCollationDuration",
        "changeStreamDelay": {
          "avg": "$avgChangeStreamDelay",
          "min": "$minChangeStreamDelay",
          "max": "$maxChangeStreamDelay",
          "percentiles":
            "$changeStreamDelayPercentiles"
        },
        "avgProcessTime": {
          "$divide": [
            "$betCollationDuration",
            "$count"
          ]
        },
        "tps": {
          "$divide": [
            "$count",
            {
              "$divide": [
                "$betCollationDuration",
                1000
              ]
            }
          ]
        }
      }
    }
  },
  {
    "$merge": {
      "into": "collationResults",
      "on": "_id",
      "whenMatched": "keepExisting",
      "whenNotMatched": "insert"
    }
  }
]